// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  OWNER
  ADMIN
  MODERATOR
  MEMBER
}

model User {
  id          Int           @id @default(autoincrement())
  username    String        @unique
  password    String
  createdAt   DateTime      @default(now())

  memberships Membership[]
  messages    Message[]
  communities Community[]   @relation("OwnedCommunities")
}

model Community {
  id            Int           @id @default(autoincrement())
  name          String
  ownerId       Int
  owner         User          @relation("OwnedCommunities", fields: [ownerId], references: [id])
  createdAt     DateTime      @default(now())

  memberships   Membership[]
  categories    Category[]
  textChannels  TextChannel[]
  voiceChannels VoiceChannel[]
}

model Membership {
  id           Int        @id @default(autoincrement())
  userId       Int
  communityId  Int
  role         Role       @default(MEMBER)
  joinedAt     DateTime   @default(now())

  user         User       @relation(fields: [userId], references: [id])
  community    Community  @relation(fields: [communityId], references: [id])

  @@unique([userId, communityId])
}

model Category {
  id            Int           @id @default(autoincrement())
  name          String
  communityId   Int
  community     Community     @relation(fields: [communityId], references: [id])
  textChannels  TextChannel[]
  voiceChannels VoiceChannel[]
}

model TextChannel {
  id           Int        @id @default(autoincrement())
  name         String
  communityId  Int
  community    Community @relation(fields: [communityId], references: [id])
  categoryId   Int?       // optional
  category     Category?  @relation(fields: [categoryId], references: [id])
  messages     Message[]
}

model VoiceChannel {
  id           Int        @id @default(autoincrement())
  name         String
  communityId  Int
  community    Community @relation(fields: [communityId], references: [id])
  categoryId   Int?       // optional
  category     Category?  @relation(fields: [categoryId], references: [id])
}

model Message {
  id            Int          @id @default(autoincrement())
  content       String
  createdAt     DateTime     @default(now())
  userId        Int
  textChannelId Int

  user          User         @relation(fields: [userId], references: [id])
  textChannel   TextChannel  @relation(fields: [textChannelId], references: [id])
}